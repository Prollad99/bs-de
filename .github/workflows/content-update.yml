name: Update Links and Deployment

on:
  schedule:
    - cron: "*/30 * * * *" # Runs every 30 minutes
  push:
    branches:
      - main

jobs:
  update-links:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        game:
          - coin-master
          - monopoly-go
          - bingo-blitz
          - dice-dreams
          - match-masters
          - solitaire-grand-harvest
          - slotpark
          - house-of-fun
          - slotomania
          - bingo-bash
          - huuuge-casino
          - wsop
          - crazy-coin
          - gametwist
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache Node modules
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers (only for crazy-coin)
        if: matrix.game == 'crazy-coin'
        run: npx playwright install --with-deps

      - name: Fetch and update links
        run: |
          mkdir -p logs # Ensure logs directory exists
          node index-js/${{ matrix.game }}.js > logs/${{ matrix.game }}.log 2>&1 || echo "Script failed but continuing"
          echo "Contents of links-json/${{ matrix.game }}.json:"
          cat links-json/${{ matrix.game }}.json || echo "No links JSON found"
          echo "Contents of _includes/${{ matrix.game }}.html:"
          cat _includes/${{ matrix.game }}.html || echo "No HTML include found"

      - name: Verify JSON integrity
        run: |
          if ! jq empty links-json/${{ matrix.game }}.json; then
            echo "Invalid JSON detected in links-json/${{ matrix.game }}.json"
            exit 1
          fi

      - name: Update date in Markdown file
        shell: bash
        run: |
          GAME_NAME=${{ matrix.game }}
          CURRENT_DATE=$(TZ=America/Los_Angeles date +'%Y-%m-%d') # Format for front matter and filename (YYYY-MM-DD)
          
          # Look for the Markdown file in _posts with the pattern *-game-name.md
          MARKDOWN_FILE=$(ls _posts/*-${GAME_NAME}.md 2>/dev/null | head -n 1)

          if [ -n "$MARKDOWN_FILE" ]; then
            # Extract the current date prefix from the filename (e.g., 2025-01-16)
            CURRENT_DATE_PREFIX=$(basename "$MARKDOWN_FILE" | grep -oE '^[0-9]{4}-[0-9]{2}-[0-9]{2}')

            # Read the existing front matter and content
            FULL_CONTENT=$(cat "$MARKDOWN_FILE")
            
            # Check if the file has front matter (starts with ---)
            if [[ $FULL_CONTENT =~ ^---[[:space:]]*[\n](.*)[\n]---[[:space:]]*[\n](.*)$ ]]; then
              FRONT_MATTER="${BASH_REMATCH[1]}"
              CONTENT="${BASH_REMATCH[2]}"
              
              # Update or add the date field in the front matter
              if [[ $FRONT_MATTER =~ ^date:[[:space:]]*(.*)$ ]]; then
                # Replace existing date
                NEW_FRONT_MATTER=$(echo "$FRONT_MATTER" | sed "s/^date:.*/date: \"$CURRENT_DATE\"/")
              else
                # Add date field
                NEW_FRONT_MATTER="$FRONT_MATTER\ndate: \"$CURRENT_DATE\""
              fi
              
              # Write the updated content back to the file
              echo -e "---\n$NEW_FRONT_MATTER\n---\n$CONTENT" > "$MARKDOWN_FILE"
              echo "Updated date in $MARKDOWN_FILE to $CURRENT_DATE"
            else
              # No front matter; add it with the date
              echo -e "---\ndate: \"$CURRENT_DATE\"\n---\n$FULL_CONTENT" > "$MARKDOWN_FILE"
              echo "Added front matter with date in $MARKDOWN_FILE"
            fi

            # Rename the file if the date prefix doesn't match the current date
            if [ "$CURRENT_DATE_PREFIX" != "$CURRENT_DATE" ]; then
              NEW_MARKDOWN_FILE="_posts/${CURRENT_DATE}-${GAME_NAME}.md"
              mv "$MARKDOWN_FILE" "$NEW_MARKDOWN_FILE"
              echo "Renamed $MARKDOWN_FILE to $NEW_MARKDOWN_FILE"
              MARKDOWN_FILE="$NEW_MARKDOWN_FILE"
            fi
          else
            echo "Markdown file for $GAME_NAME not found in _posts, creating new file"
            MARKDOWN_FILE="_posts/${CURRENT_DATE}-${GAME_NAME}.md"
            GAME_NAME_CAPITALIZED=$(echo "$GAME_NAME" | sed 's/-/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)}1')
            declare -A GAME_TYPES
            GAME_TYPES=(
              ["bingo-bash"]="Gratis Chips"
              ["bingo-blitz"]="Gratis Credits"
              ["coin-master"]="Gratis Spins"
              ["crazy-coin"]="Gratis Spins"
              ["dice-dreams"]="Gratis Würfe"
              ["gametwist"]="Gratis Münzen"
              ["house-of-fun"]="Gratis Münzen"
              ["huuuge-casino"]="Gratis Chips"
              ["match-masters"]="Gratis Geschenke"
              ["monopoly-go"]="Würfel"
              ["slotomania"]="Gratis Münzen"
              ["slotpark"]="Bonuscode"
              ["solitaire-grand-harvest"]="Gratis Münzen"
              ["wsop"]="Gratis Chips"
            )
            GAME_TYPE=${GAME_TYPES[$GAME_NAME]}
            GAME_TYPE_LOWER=$(echo "$GAME_TYPE" | tr '[:upper:]' '[:lower:]')
            cat <<EOL > "$MARKDOWN_FILE"
---
title: "${GAME_NAME_CAPITALIZED} ${GAME_TYPE} – Links auf Deutsch"
description: "Sichere dir täglich bis zu 100 kostenlose ${GAME_NAME_CAPITALIZED} ${GAME_TYPE}! Neue Gratis-Links für deutsche Spieler – 100% sicher und aktuell."
date: "$CURRENT_DATE"
permalink: /${GAME_NAME}-${GAME_TYPE_LOWER}-links/
image: /assets/images/${GAME_NAME}.webp
alt: "${GAME_NAME_CAPITALIZED} ${GAME_TYPE} Belohnung"
manifest: /manifests/${GAME_NAME}.json
tags:
  - "${GAME_NAME} ${GAME_TYPE_LOWER}"
  - "${GAME_NAME} kostenlose ${GAME_TYPE_LOWER}"
  - "${GAME_NAME} tägliche links"
  - "${GAME_NAME} ${GAME_TYPE_LOWER} heute"
  - "${GAME_NAME} belohnungen gratis"
  - "${GAME_NAME} ${GAME_TYPE_LOWER} 2025"
---
{% include ${GAME_NAME}_post.html %}

{% include ${GAME_NAME}.html %}

{% include ${GAME_NAME}_footer.html %}
EOL
            echo "Created $MARKDOWN_FILE"
          fi

      - name: Generate dynamic content
        shell: bash
        run: |
          declare -A GAME_TYPES
          GAME_TYPES=(
            ["bingo-bash"]="Gratis Chips"
            ["bingo-blitz"]="Gratis Credits"
            ["coin-master"]="Gratis Spins"
            ["crazy-coin"]="Gratis Spins"
            ["dice-dreams"]="Gratis Würfe"
            ["gametwist"]="Gratis Münzen"
            ["house-of-fun"]="Gratis Münzen"
            ["huuuge-casino"]="Gratis Chips"
            ["match-masters"]="Gratis Geschenke"
            ["monopoly-go"]="Würfel"
            ["slotomania"]="Gratis Münzen"
            ["slotpark"]="Bonuscode"
            ["solitaire-grand-harvest"]="Gratis Münzen"
            ["wsop"]="Gratis Chips"
          )

          GAME_NAME=${{ matrix.game }}
          GAME_NAME_CAPITALIZED=$(echo "$GAME_NAME" | sed 's/-/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)}1')
          GAME_TYPE=${GAME_TYPES[$GAME_NAME]}
          CURRENT_DATE=$(TZ=America/Los_Angeles date +'%d.%m.%Y %H:%M') # Set timezone to PDT

          POST_FILE="_includes/${GAME_NAME}_post.html"
          FOOTER_FILE="_includes/${GAME_NAME}_footer.html"

          # Updated H1 for better SEO
          POST_CONTENT="# Tägliche ${GAME_NAME_CAPITALIZED} Gratis ${GAME_TYPE} – Jetzt Sammeln!\n\nWillkommen bei deiner Quelle für **${GAME_NAME_CAPITALIZED} Gratis ${GAME_TYPE}**! Hier findest du täglich neue Links, um kostenlose ${GAME_TYPE} und Belohnungen zu sammeln – perfekt für deutsche Spieler.\n\n---\n\nBist du ein leidenschaftlicher **${GAME_NAME_CAPITALIZED}**-Spieler? Hier findest du täglich neue **Gratis ${GAME_TYPE}**-Links, um kostenlose Belohnungen zu sammeln – 100% sicher und gratis!\n\nKlicke einfach auf die Links unten, melde dich in deinem **${GAME_NAME_CAPITALIZED}**-Konto an und sichere dir deine **Gratis ${GAME_TYPE}** – sie sind sofort im Spiel verfügbar. Schau täglich vorbei, da die Links schnell ablaufen!\n\n---\n\n## Aktuelle ${GAME_NAME_CAPITALIZED} ${GAME_TYPE} Links"

          # Updated FOOTER_CONTENT with new section and internal links
          FOOTER_CONTENT="---\n\n## Was sind ${GAME_TYPE}-Links?\n\n**${GAME_TYPE}**-Links sind offizielle Belohnungen von den **${GAME_NAME_CAPITALIZED}**-Entwicklern. Sie bieten kostenlose **${GAME_TYPE}** wie Spins, Würfe, Credits oder spezielle Geschenke. Wir sammeln und prüfen diese Links täglich, damit du sie mühelos einlösen kannst.\n\n---\n\n## Warum diese Seite dein ${GAME_NAME_CAPITALIZED}-Begleiter ist\n\nWir helfen dir, in **${GAME_NAME_CAPITALIZED}** vorne zu bleiben:\n\n- **Tägliche Updates:** Neue **${GAME_TYPE}**-Links jeden Tag (Stand: ${CURRENT_DATE}).\n- **100 % sicher:** Links direkt aus offiziellen **${GAME_NAME_CAPITALIZED}**-Quellen.\n- **Kostenlos:** Keine Gebühren, keine Anmeldung – nur Belohnungen!\n\n---\n\n## Wie Man ${GAME_NAME_CAPITALIZED} ${GAME_TYPE} Optimal Nutzt\n\nUm das Beste aus deinen Gratis ${GAME_TYPE} herauszuholen, solltest du strategisch vorgehen. Nutze deine ${GAME_TYPE} während Events wie \"Viking Quest\" oder \"Spin Master\", um höhere Belohnungen zu erzielen. Sammle Münzen, um dein Dorf auszubauen, aber achte darauf, nicht zu viele Münzen zu horten – das macht dich anfälliger für Angriffe. Plane deine ${GAME_TYPE} für Tage, an denen du mehr Zeit hast, um aktiv zu spielen. So maximierst du deinen Fortschritt und genießt ${GAME_NAME_CAPITALIZED} noch mehr!\n\n---\n\n## Profi-Tipps für mehr ${GAME_TYPE}\n\nMaximiere deine Gratis-Belohnungen mit diesen Tricks:\n\n### Spins & Würfe sparen\nNutze sie bei Events mit hohen Gewinnen.\n\n### Münzen strategisch einsetzen\nInvestiere klug, um schneller voranzukommen.\n\n### Täglich checken\nLinks sind kurzlebig – sei schnell!\n\n---\n\n## Häufige Fragen zu ${GAME_TYPE}\n\n### Sind diese ${GAME_TYPE}-Links sicher?\n\nJa! Wir teilen ausschließlich Links, die direkt aus offiziellen **${GAME_NAME_CAPITALIZED}**-Aktionen stammen – sie sind völlig sicher und legitim.\n\n### Wie oft werden die Links aktualisiert?\n\nTäglich! Besuche uns regelmäßig für frische **${GAME_TYPE}**.\n\n### Was wenn ein Link nicht funktioniert?\n\nEinige Links haben eine begrenzte Anzahl an Einlösungen oder laufen schnell ab. Falls einer nicht funktioniert, keine Sorge – neue werden bald verfügbar sein!\n\n---\n\n## Entdecke Mehr Gratis-Links\n\n- [Bingo Bash Gratis Chips](/bingo-bash-gratis-chips/)\n- [Slotomania Gratis Münzen](/slotomania-gratis-muenzen/)\n\n---\n\n## Haftungsausschluss\n\nWir sind **nicht mit ${GAME_NAME_CAPITALIZED}** oder seinen Entwicklern verbunden. Diese Seite hilft Spielern, kostenlose **${GAME_TYPE}** zu finden und das Spiel zu genießen."

          # Write content to files
          echo -e "$POST_CONTENT" > "$POST_FILE"
          echo -e "$FOOTER_CONTENT" > "$FOOTER_FILE"

      - name: Configure Git
        run: |
          git config --global user.email "prolladmail@gmail.com"
          git config --global user.name "Prollad99"

      - name: Commit and push changes
        env:
          ACTIONS_DEPLOY_KEY: ${{ secrets.ACTIONS_DEPLOY_KEY }}
        run: |
          # Add files that always exist
          git add _includes/${{ matrix.game }}.html _includes/${{ matrix.game }}_post.html _includes/${{ matrix.game }}_footer.html links-json/${{ matrix.game }}.json logs/${{ matrix.game }}.log

          # Conditionally add the Markdown file if it exists
          CURRENT_DATE=$(TZ=America/Los_Angeles date +'%Y-%m-%d')
          MARKDOWN_FILE=$(ls _posts/*-${{ matrix.game }}.md 2>/dev/null | head -n 1)
          if [ -n "$MARKDOWN_FILE" ]; then
            git add "$MARKDOWN_FILE"
            echo "Added $MARKDOWN_FILE to staging"
            # If the file was renamed, add the new file as well
            NEW_MARKDOWN_FILE="_posts/${CURRENT_DATE}-${{ matrix.game }}.md"
            if [ "$MARKDOWN_FILE" != "$NEW_MARKDOWN_FILE" ] && [ -f "$NEW_MARKDOWN_FILE" ]; then
              git add "$NEW_MARKDOWN_FILE"
              echo "Added renamed file $NEW_MARKDOWN_FILE to staging"
            fi
          else
            # If the file was created, add it
            NEW_MARKDOWN_FILE="_posts/${CURRENT_DATE}-${{ matrix.game }}.md"
            if [ -f "$NEW_MARKDOWN_FILE" ]; then
              git add "$NEW_MARKDOWN_FILE"
              echo "Added newly created $NEW_MARKDOWN_FILE to staging"
            else
              echo "Markdown file for ${{ matrix.game }} not found, skipping git add"
            fi
          fi

          # Commit and push if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit for ${{ matrix.game }}"
          else
            git commit -m "Update ${{ matrix.game }} links, content, and date - $(date '+%Y-%m-%d %H:%M')"
            for i in {1..5}; do
              git pull --rebase && git push https://x-access-token:${{ secrets.ACTIONS_DEPLOY_KEY }}@github.com/Prollad99/bs-de.git && break
              echo "Attempt $i: Push failed, retrying in 5 seconds..."
              sleep 5
            done || echo "❌ All push attempts failed for ${{ matrix.game }}"
          fi