name: Aktualisiere Links und Bereitstellung

on:
  schedule:
    - cron: '*/30 * * * *' # L√§uft alle 30 Minuten
  push:
    branches:
      - main

jobs:
  links-aktualisieren:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        game:
          - coin-master
          - monopoly-go
          - bingo-blitz
          - dice-dreams
          - match-masters
          - solitaire-grand-harvest
          - slotpark
          - house-of-fun
          - slotomania
          - bingo-bash
          - huuuge-casino
          - wsop
          - crazy-coin
          - gametwist

    steps:
      - name: Repository auschecken
        uses: actions/checkout@v2

      - name: Node-Module zwischenspeichern
        uses: actions/cache@v2
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Abh√§ngigkeiten installieren
        run: npm install

      - name: Installiere Playwright-Browser
        run: npx playwright install

      - name: Links abrufen und aktualisieren
        run: |
          node index-js/${{ matrix.game }}.js

      - name: Dynamische Beitragsinhalte generieren
        run: |
          SPIEL_NAME=${{ matrix.game }}
          SPIEL_NAME_KAPITALISIERT=$(echo "$SPIEL_NAME" | sed 's/-/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)}1')

          ABSATZ_DATEI="_includes/${SPIEL_NAME}_post.html"
          ABSATZ="## ${SPIEL_NAME_KAPITALISIERT} ‚Äì T√§gliche Belohnungen & Tipps\n\n
          **Hol dir t√§glich exklusive Belohnungen f√ºr ${SPIEL_NAME_KAPITALISIERT}!** Wir stellen dir die neuesten Bonuslinks bereit, mit denen du Freispiele, M√ºnzen, Chips und andere Belohnungen sammeln kannst.\n\n
          ### üéÆ Was ist ${SPIEL_NAME_KAPITALISIERT}?\n
          ${SPIEL_NAME_KAPITALISIERT} ist ein spannendes und unterhaltsames Spiel, das Millionen von Spielern weltweit begeistert. Es bietet t√§gliche Herausforderungen, Events und Belohnungen, die dein Spielerlebnis verbessern.\n\n
          ### üèÜ Warum solltest du Belohnungen einl√∂sen?\n
          - **Mehr Spielzeit** ‚Äì Genie√üe das Spiel ohne Unterbrechungen.\n
          - **Schneller Fortschritt** ‚Äì Steige schneller auf und schalte neue Inhalte frei.\n
          - **Events optimal nutzen** ‚Äì Einige Boni sind nur f√ºr kurze Zeit verf√ºgbar!\n\n
          ### üí° Pro Tipp:\n
          ‚ÄûSpeichere deine Belohnungen f√ºr besondere Events oder Herausforderungen, um den maximalen Vorteil zu erzielen!‚Äú\n\n
          Bleib dran und sichere dir t√§glich deine ${SPIEL_NAME_KAPITALISIERT}-Belohnungen!\n\n
          *Hinweis: Bonuscollector.net steht in keiner Verbindung zu den Entwicklern von ${SPIEL_NAME_KAPITALISIERT}. Alle Links stammen aus offiziellen Quellen.*"
          echo -e "$ABSATZ" > "$ABSATZ_DATEI"

      - name: Dynamische Footer-Inhalte generieren
        run: |
          SPIEL_NAME=${{ matrix.game }}
          SPIEL_NAME_KAPITALISIERT=$(echo "$SPIEL_NAME" | sed 's/-/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)}1')

          FOOTER_DATEI="_includes/${SPIEL_NAME}_footer.html"
          FOOTER="### ‚ÑπÔ∏è H√§ufig gestellte Fragen (FAQs)\n\n
          **1Ô∏è‚É£ Wie l√∂se ich meine ${SPIEL_NAME_KAPITALISIERT}-Belohnungen ein?**\n
          - Klicke auf den gew√ºnschten Belohnungslink oben.\n
          - Die ${SPIEL_NAME_KAPITALISIERT}-App oder Website √∂ffnet sich automatisch.\n
          - Falls erforderlich, melde dich mit deinem Spielkonto an.\n
          - Die Belohnung wird sofort deinem Konto gutgeschrieben.\n\n
          **2Ô∏è‚É£ Warum funktioniert ein Belohnungslink nicht?**\n
          - Einige Links haben ein **Ablaufdatum** oder eine **begrenzte Anzahl an Einl√∂sungen**.\n
          - Stelle sicher, dass du mit dem **richtigen Konto** angemeldet bist.\n
          - Falls ein Link nicht funktioniert, probiere einen anderen oder besuche uns sp√§ter erneut.\n\n
          **3Ô∏è‚É£ Sind diese Belohnungen offiziell?**\n
          Ja, die Belohnungen stammen aus **offiziellen Quellen** wie den sozialen Medien oder Werbekampagnen der Spieleentwickler. Wir sammeln und teilen sie f√ºr euch an einem praktischen Ort.\n\n
          **üí° Tipps zur Fehlerbehebung:**\n
          - Stelle sicher, dass du eine **stabile Internetverbindung** hast.\n
          - Aktualisiere deine **${SPIEL_NAME_KAPITALISIERT}-App** auf die neueste Version.\n
          - Versuche, den Link auf einem **anderen Ger√§t oder Browser** zu √∂ffnen.\n\n
          Viel Spa√ü mit deinen Belohnungen in ${SPIEL_NAME_KAPITALISIERT}!"
          echo -e "$FOOTER" > "$FOOTER_DATEI"

      - name: Letztes √Ñnderungsdatum der Include-Datei aktualisieren
        run: |
          export TZ=UTC
          ZEITSTEMPEL=$(date -u +"%Y-%m-%d %H:%M:%S")
          INCLUDE_FILES_YML="_data/include_files.yml"

          if git diff --quiet _includes/${{ matrix.game }}.html; then
            echo "_includes/${{ matrix.game }}.html wurde nicht ge√§ndert."
          else
            if grep -q "${{ matrix.game }}.html:" "$INCLUDE_FILES_YML"; then
              sed -i "/${{ matrix.game }}.html:/,/last_modified:/s|last_modified: .*|last_modified: $ZEITSTEMPEL|" "$INCLUDE_FILES_YML"
            else
              echo -e "\n${{ matrix.game }}.html:\n  last_modified: $ZEITSTEMPEL" >> "$INCLUDE_FILES_YML"
            fi
          fi

      - name: Git konfigurieren und √Ñnderungen committen
        run: |
          git config --global user.email "prolladmail@gmail.com"
          git config --global user.name "Prollad99"

          # Fetch the latest changes from the remote repository before proceeding
          git fetch origin

          # Rebase or merge changes if needed
          git rebase origin/main || git merge origin/main

          # Add the changes and commit
          git add _includes/${{ matrix.game }}.html _includes/${{ matrix.game }}_post.html _includes/${{ matrix.game }}_footer.html links-json/${{ matrix.game }}.json _data/include_files.yml
          git commit -m "Aktualisiere Inhalte f√ºr ${{ matrix.game }}" || true

          # Push the changes back to the repository
          git push https://x-access-token:${{ secrets.ACTIONS_DEPLOY_KEY }}@github.com/Prollad99/bs-de.git