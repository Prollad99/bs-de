name: Automated Content Updates & SEO

on:
  schedule:
    - cron: '*/30 * * * *' # Every 30 minutes
  push:
    branches:
      - main

jobs:
  content-update:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        game:
          - coin-master
          - monopoly-go
          - bingo-blitz
          - dice-dreams
          - match-masters
          - solitaire-grand-harvest
          - slotpark
          - house-of-fun
          - slotomania
          - bingo-bash
          - huuuge-casino
          - wsop
          - crazy-coin

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install Dependencies
        run: |
          npm install
          npx playwright install

      - name: Update Game Links
        run: node index-js/${{ matrix.game }}.js

      - name: Generate SEO Content
        run: |
          CURRENT_DATE=$(date +'%Y-%m-%d')  # Store the current date in a variable
          GAME_NAME=${{ matrix.game }}
          FORMATTED_NAME=$(echo "$GAME_NAME" | sed 's/-/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)}1')

          # Generate Post Content with the actual date
          cat <<EOF > "_includes/${GAME_NAME}_post.html"
          ### üéÆ $FORMATTED_NAME Kostenlose Belohnungen (Aktualisiert: $CURRENT_DATE)

          Erhalte t√§glich aktualisierte $FORMATTED_NAME-Links f√ºr:
          ‚úÖ Kostenlose Spins  
          ‚úÖ Bonusm√ºnzen  
          ‚úÖ Zeitlich begrenzte Angebote  

          **Warum unsere Links verwenden?**  
          - Alle 30 Minuten aktualisiert  
          - Funktioniert auf allen Ger√§ten  
          - Kein Login erforderlich  

          ‚ö†Ô∏è Voraussetzungen:  
          - Neueste Spielversion installiert  
          - Stabile Internetverbindung  

          *√úberpr√ºft und funktionsf√§hig ab $CURRENT_DATE*
          EOF

          # Generate Footer with the actual date
          cat <<EOF > "_includes/${GAME_NAME}_footer.html"
          ## üîç So l√∂st du $FORMATTED_NAME-Belohnungen ein  
          1. Klicke auf einen beliebigen Link oben  
          2. Warte, bis das Spiel startet  
          3. Deine Belohnungen werden automatisch eingel√∂st  

          **Tipps:**  
          - Links verfallen nach 48 Stunden  
          - Aktualisiere die Seite f√ºr neue Updates  
          - Kontaktiere den Support bei fehlgeschlagenen Anspr√ºchen  
          EOF

      - name: Deploy Changes
        env: 
          DEPLOY_KEY: ${{ secrets.ACTIONS_DEPLOY_KEY }}
        run: |
          git config user.email "prolladmail@gmail.com"
          git config user.name "Auto-Updater"
          
          # Stage all changes and commit
          git add -A
          git commit -m "Staged changes" || echo "No changes to commit"
          
          # Fetch all remote changes
          git fetch origin

          # Rebase with the remote main branch
          git rebase origin/main || { echo 'Rebase failed, attempting merge instead...'; git merge origin/main; }

          # Commit any new changes after rebase
          git add _includes/
          git commit -m "Update ${{ matrix.game }} content" || echo "No changes to commit"
          
          # Push changes
          git push https://x-access-token:$DEPLOY_KEY@github.com/Prollad99/bs-de.git HEAD:main