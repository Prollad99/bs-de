name: Update Links and Deployment

on:
  schedule:
    - cron: '*/30 * * * *'
  push:
    branches:
      - main

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.npm
            ~/.cache/playwright
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

      - name: Install dependencies
        run: |
          npm ci
          sudo apt-get update
          sudo apt-get install -y libgbm-dev
          npx playwright install --with-deps

      - name: Process game links
        shell: bash
        env:
          GAMES: "coin-master monopoly-go bingo-blitz dice-dreams match-masters solitaire-grand-harvest slotpark house-of-fun slotomania bingo-bash huuuge-casino wsop crazy-coin gametwist"
        run: |
          git config --global user.email "prolladmail@gmail.com"
          git config --global user.name "Prollad99"
          git config --global pull.rebase true

          for GAME in $GAMES; do
            echo "‚ÑπÔ∏è Processing $GAME..."
            
            if ! node "index-js/$GAME.js"; then
              echo "‚ùå Error processing $GAME script"
              exit 1
            fi

            declare -A GAME_TYPES=(
              ["bingo-bash"]="Gratis Chips"
              ["bingo-blitz"]="Gratis Credits"
              ["coin-master"]="Gratis Spins"
              ["crazy-coin"]="Gratis Spins"
              ["dice-dreams"]="Gratis W√ºrfe"
              ["gametwist"]="Gratis M√ºnzen"
              ["house-of-fun"]="Gratis M√ºnzen"
              ["huuuge-casino"]="Gratis Chips"
              ["match-masters"]="Gratis Geschenke"
              ["monopoly-go"]="W√ºrfel"
              ["slotomania"]="Gratis M√ºnzen"
              ["slotpark"]="Bonuscode"
              ["solitaire-grand-harvest"]="Gratis M√ºnzen"
              ["wsop"]="Gratis Chips"
            )

            GAME_NAME_CAPITALIZED=$(echo "$GAME" | sed 's/-/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)}1')
            GAME_TYPE=${GAME_TYPES[$GAME]}

            # Generate HTML post content
            POST_CONTENT=$(printf '<div class="game-content">
              <p>M√∂chtest du <strong>%s</strong> sammeln, ohne echtes Geld auszugeben? Dann bist du hier genau richtig!</p>
              
              <div class="update-info">
                <p>Wir aktualisieren diese Seite <strong>t√§glich</strong> mit neuen %s-Links:</p>
                <ul>
                  <li>Verbessere dein Gameplay</li>
                  <li>Steige schneller auf</li>
                  <li>Freischalte spannende Belohnungen</li>
                </ul>
              </div>

              <hr>

              <section class="content-section">
                <h2>Was sind %s-Links?</h2>
                <p>Diese offiziellen Belohnungen der %s-Entwickler bieten:</p>
                <ul class="benefits-list">
                  <li>Kostenlose %s</li>
                  <li>Spins/W√ºrfe/Credits</li>
                  <li>Spezielle Geschenke</li>
                </ul>
                <p class="highlight">Wir √ºbernehmen die Link-Suche f√ºr dich!</p>
              </section>

              <hr>

              <section class="tutorial-section">
                <h2>So l√∂st du deine %s ein</h2>
                <ol class="steps">
                  <li>W√§hle einen Link aus unserer Liste</li>
                  <li>Klicke und melde dich in deinem %s-Konto an</li>
                  <li>Erhalte sofort deine Belohnung!</li>
                </ol>
                <div class="tip-box">
                  <p>üîî Tipp: Links laufen schnell ab - t√§glich vorbeischauen!</p>
                </div>
              </section>

              <hr>

              <section class="todays-links">
                <h2>Heutige Gratis-%s</h2>
              </section>
            </div>' "$GAME_NAME_CAPITALIZED" "$GAME_TYPE" "$GAME_TYPE" "$GAME_TYPE" \
              "$GAME_NAME_CAPITALIZED" "$GAME_TYPE" "$GAME_TYPE" "$GAME_NAME_CAPITALIZED" "$GAME_TYPE")

            # Generate HTML footer content
            FOOTER_CONTENT=$(printf '<div class="footer-content">
              <hr>
              
              <section class="why-save">
                <h2>Warum diese Seite speichern?</h2>
                <div class="benefits">
                  <div class="benefit-item">
                    <h3>‚úÖ T√§gliche Updates</h3>
                    <p>Immer aktuelle %s-Links</p>
                  </div>
                  <div class="benefit-item">
                    <h3>‚úÖ 100%% Sicher</h3>
                    <p>Gepr√ºfte Links von %s</p>
                  </div>
                  <div class="benefit-item">
                    <h3>‚úÖ Komplett kostenlos</h3>
                    <p>Keine Anmeldung, keine Geb√ºhren</p>
                  </div>
                </div>
              </section>

              <hr>

              <section class="pro-tips">
                <h2>Profi-Tipps f√ºr maximale %s</h2>
                <div class="tip-grid">
                  <div class="tip">
                    <h4>Clever einsetzen</h4>
                    <p>Spare Spins f√ºr Events mit hohen Belohnungen</p>
                  </div>
                  <div class="tip">
                    <h4>Strategisch verwalten</h4>
                    <p>Investiere M√ºnzen gezielt f√ºr schnellen Fortschritt</p>
                  </div>
                  <div class="tip">
                    <h4>T√§glich einloggen</h4>
                    <p>Sichere dir zeitlich begrenzte Links</p>
                  </div>
                </div>
              </section>

              <hr>

              <section class="faq">
                <h2>H√§ufige Fragen</h2>
                <div class="faq-item">
                  <h3>Sind die Links sicher?</h3>
                  <p>Ja! Alle Links stammen aus offiziellen %s-Quellen.</p>
                </div>
                <div class="faq-item">
                  <h3>Update-H√§ufigkeit?</h3>
                  <p>T√§gliche Aktualisierungen garantierte frische Links.</p>
                </div>
                <div class="faq-item">
                  <h3>Link funktioniert nicht?</h3>
                  <p>Neue Links kommen bald - einfach sp√§ter nochmal versuchen!</p>
                </div>
              </section>

              <hr>

              <div class="disclaimer">
                <p>Haftungsausschluss: Nicht verbunden mit %s oder dessen Entwicklern.</p>
              </div>
            </div>' "$GAME_TYPE" "$GAME_NAME_CAPITALIZED" "$GAME_TYPE" \
              "$GAME_NAME_CAPITALIZED" "$GAME_NAME_CAPITALIZED")

            # Write HTML files
            echo "$POST_CONTENT" | sed 's/^              //' > "_includes/${GAME}_post.html"
            echo "$FOOTER_CONTENT" | sed 's/^              //' > "_includes/${GAME}_footer.html"

            git add "index-js/$GAME.js" \
                   "_includes/$GAME.html" \
                   "_includes/${GAME}_post.html" \
                   "_includes/${GAME}_footer.html" \
                   "links-json/$GAME.json"
          done

          git commit -m "ü§ñ HTML content update: $(date +'%Y-%m-%d %H:%M')" || echo "‚è© No changes"
          
          MAX_RETRIES=5
          for ((i=1; i<=$MAX_RETRIES; i++)); do
            git pull --rebase
            if git push "https://x-access-token:${{ secrets.ACTIONS_DEPLOY_KEY }}@github.com/Prollad99/bs-de.git" HEAD:main; then
              echo "‚úÖ Push successful"
              break
            else
              echo "üîÑ Attempt $i/$MAX_RETRIES failed, retrying..."
              sleep 5
            fi
          done

          if [ $i -gt $MAX_RETRIES ]; then
            echo "‚ùå All push attempts failed"
            exit 1
          fi