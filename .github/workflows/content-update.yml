name: Aktualisiere Links und Bereitstellung

on:
  schedule:
    - cron: '*/30 * * * *' # Läuft alle 30 Minuten
  push:
    branches:
      - main

jobs:
  links-aktualisieren:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        game:
          - coin-master
          - monopoly-go
          - bingo-blitz
          - dice-dreams
          - match-masters
          - solitaire-grand-harvest
          - slotpark
          - house-of-fun
          - slotomania
          - bingo-bash
          - huuuge-casino
          - wsop
          - crazy-coin
          - gametwist

    steps:
      - name: Repository auschecken
        uses: actions/checkout@v2

      - name: Node-Module zwischenspeichern
        uses: actions/cache@v2
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Abhängigkeiten installieren
        run: npm install

      - name: Installiere Playwright-Browser
        run: npx playwright install

      - name: Links abrufen und aktualisieren
        run: |
          node index-js/${{ matrix.game }}.js
          echo "Inhalt von links-json/${{ matrix.game }}.json:"
          cat links-json/${{ matrix.game }}.json
          echo "Inhalt von _includes/${{ matrix.game }}.html:"
          cat _includes/${{ matrix.game }}.html

      - name: Dynamische Beitragsinhalte generieren
        run: |
          SPIEL_NAME=${{ matrix.game }}
          SPIEL_NAME_KAPITALISIERT=$(echo "$SPIEL_NAME" | sed 's/-/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)}1')

          ABSATZ_DATEI="_includes/${SPIEL_NAME}_post.html"
          ABSATZ="Bist du ein engagierter **${SPIEL_NAME_KAPITALISIERT}**-Spieler? Suchst du nach der einfachsten Möglichkeit, kostenlose Münzen, Spins und andere Boni zu sammeln? Dann bist du hier genau richtig! Wir aktualisieren diese Seite täglich mit neuen Belohnungslinks, damit du keine Chance verpasst, schneller aufzuleveln und das Spiel in vollen Zügen zu genießen.\n\n
          ## **Was sind Belohnungslinks?**\n
          Belohnungslinks sind offizielle Aktionen der **${SPIEL_NAME_KAPITALISIERT}**-Entwickler, die den Spielern kostenlose In-Game-Gegenstände wie Spins, Münzen und exklusive Boni bieten. Sie sind eine großartige Möglichkeit, dein Gameplay zu verbessern, ohne Geld auszugeben.\n\n
          Jeden Tag stellen wir dir die neuesten und zuverlässigsten Belohnungslinks zur Verfügung, damit du deine Belohnungen problemlos einlösen und deine Reise ohne Unterbrechungen fortsetzen kannst.\n\n
          ---\n\n
          ## **So kannst du deine kostenlosen Belohnungen einlösen**\n
          Das Einlösen deiner täglichen Belohnungen ist ganz einfach und erfordert nur wenige Schritte:\n
          1. **Wähle einen Belohnungslink aus der Liste unten aus.**\n
          2. **Tippe auf den Link und melde dich in deinem ${SPIEL_NAME_KAPITALISIERT}-Konto an.**\n
          3. **Die Belohnung wird sofort deinem Konto gutgeschrieben!**\n\n
          Schau regelmäßig auf dieser Seite vorbei, da die Links schnell ablaufen können. Verpasse keine Gelegenheit!\n\n
          ---\n\n
          ## **Heutige ${SPIEL_NAME_KAPITALISIERT} Belohnungslinks**"
          echo -e "$ABSATZ" > "$ABSATZ_DATEI"

      - name: Dynamische Footer-Inhalte generieren
        run: |
          SPIEL_NAME=${{ matrix.game }}
          SPIEL_NAME_KAPITALISIERT=$(echo "$SPIEL_NAME" | sed 's/-/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)}1')

          FOOTER_DATEI="_includes/${SPIEL_NAME}_footer.html"
          FOOTER="---\n\n
          ## **Warum du unsere täglichen Belohnungs-Updates verfolgen solltest**\n
          Wir helfen Spielern wie dir, das Beste aus ihrem Spielerlebnis herauszuholen. Hier sind die Gründe, warum sich ein Lesezeichen für unsere Seite lohnt:\n
          - **Tägliche Updates:** Hier findest du immer die neuesten Belohnungslinks.\n
          - **Sicher und zuverlässig:** Alle Belohnungen stammen aus offiziellen **${SPIEL_NAME_KAPITALISIERT}**-Aktionen.\n
          - **Komplett kostenlos:** Keine versteckten Kosten oder Tricks – nur kostenlose Belohnungen!\n\n
          ---\n\n
          ## **Profi-Tipps für die Nutzung kostenloser Belohnungen**\n
          Nutze deine Belohnungen optimal mit diesen hilfreichen Tipps:\n
          - **Setze kostenlose Spins strategisch ein:** Spare dir deine Spins für besondere Events auf, um deine Gewinnchancen zu maximieren.\n
          - **Plane deine Münzenausgaben:** Investiere deine Münzen klug, um schneller aufzuleveln und Premium-Funktionen freizuschalten.\n
          - **Täglich einloggen:** Viele Belohnungen sind zeitlich begrenzt, also logge dich regelmäßig ein, um keine Angebote zu verpassen.\n\n
          ---\n\n
          ## **Häufig gestellte Fragen (FAQs)**\n\n
          ### **1. Sind diese Belohnungslinks sicher?**\n
          Ja! Alle unsere Links stammen aus offiziellen **${SPIEL_NAME_KAPITALISIERT}**-Aktionen und sind daher sicher und zuverlässig.\n\n
          ### **2. Wie oft werden die Belohnungslinks aktualisiert?**\n
          Wir aktualisieren unsere Seite täglich, um dir die neuesten aktiven Links bereitzustellen. Setze ein Lesezeichen und schaue jeden Tag vorbei!\n\n
          ### **3. Was passiert, wenn ein Link nicht funktioniert?**\n
          Einige Links können schnell ablaufen oder sind nur für eine begrenzte Anzahl an Einlösungen verfügbar. Falls ein Link nicht funktioniert, schaue später wieder vorbei, um neue zu finden.\n\n
          ---\n\n
          ## **Haftungsausschluss**\n
          Wir stehen in keiner Verbindung zu den Entwicklern von **${SPIEL_NAME_KAPITALISIERT}**. Alle Inhalte dienen ausschließlich Informationszwecken und sollen Spielern helfen, kostenlose Belohnungen einfach zu erhalten."
          echo -e "$FOOTER" > "$FOOTER_DATEI"

      - name: Letztes Änderungsdatum der Include-Datei aktualisieren
        run: |
          export TZ=UTC
          ZEITSTEMPEL=$(date -u +"%Y-%m-%d %H:%M:%S")
          INCLUDE_FILES_YML="_data/include_files.yml"

          if git diff --quiet _includes/${{ matrix.game }}.html; then
            echo "_includes/${{ matrix.game }}.html wurde nicht geändert. Aktualisierung des letzten Änderungsdatums übersprungen."
          else
            if grep -q "${{ matrix.game }}.html:" "$INCLUDE_FILES_YML"; then
              sed -i "/${{ matrix.game }}.html:/,/last_modified:/s|last_modified: .*|last_modified: $ZEITSTEMPEL|" "$INCLUDE_FILES_YML"
            else
              echo -e "\n${{ matrix.game }}.html:\n  last_modified: $ZEITSTEMPEL" >> "$INCLUDE_FILES_YML"
            fi
          fi

      - name: Git konfigurieren
        run: |
          git config --global user.email "prolladmail@gmail.com"
          git config --global user.name "Prollad99"

      - name: Änderungen committen und pushen
        env:
          ACTIONS_DEPLOY_KEY: ${{ secrets.ACTIONS_DEPLOY_KEY }}
        run: |
          git add _includes/${{ matrix.game }}.html _includes/${{ matrix.game }}_post.html _includes/${{ matrix.game }}_footer.html links-json/${{ matrix.game }}.json _data/include_files.yml
          git add package.json package-lock.json || true
          git commit -m "Aktualisiere ${{ matrix.game }}-Belohnungslinks, Inhalte und Änderungsdatum" || true
          git stash
          git pull --rebase || true
          git stash pop || true
          for i in {1..5}; do
            git push https://x-access-token:${{ secrets.ACTIONS_DEPLOY_KEY }}@github.com/Prollad99/bs-de.git && break
            echo "Versuch $i: Push fehlgeschlagen, erneuter Versuch in 5 Sekunden..."
            sleep 5
            git pull --rebase || true
          done