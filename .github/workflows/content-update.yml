name: Automated Content Updates & SEO

on:
  schedule:
    - cron: '*/30 * * * *' # Run every 30 minutes
  push:
    branches:
      - main

jobs:
  content-update:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        game:
          - coin-master
          - monopoly-go
          - bingo-blitz
          - dice-dreams
          - match-masters
          - solitaire-grand-harvest
          - slotpark
          - house-of-fun
          - slotomania
          - bingo-bash
          - huuuge-casino
          - wsop
          - crazy-coin

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install Dependencies
        run: |
          npm install
          npx playwright install

      - name: Get Current Date
        id: date
        run: echo "CURRENT_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV

      - name: Update Game Links
        run: node index-js/${{ matrix.game }}.js

      - name: Generate SEO Content
        run: |
          GAME_NAME=${{ matrix.game }}
          FORMATTED_NAME=$(echo "$GAME_NAME" | sed 's/-/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)}1')

          # Generate Post Content with the actual date
          echo "### 🎮 $FORMATTED_NAME Kostenlose Belohnungen (Aktualisiert: ${{ env.CURRENT_DATE }})

          Erhalte täglich aktualisierte $FORMATTED_NAME-Links für:
          ✅ Kostenlose Spins  
          ✅ Bonusmünzen  
          ✅ Zeitlich begrenzte Angebote  

          **Warum unsere Links verwenden?**  
          - Alle 30 Minuten aktualisiert  
          - Funktioniert auf allen Geräten  
          - Kein Login erforderlich  

          ⚠️ Voraussetzungen:  
          - Neueste Spielversion installiert  
          - Stabile Internetverbindung  

          *Überprüft und funktionsfähig ab ${{ env.CURRENT_DATE }}*" > "_includes/${GAME_NAME}_post.html"

          # Generate Footer with the actual date
          echo "## 🔍 So löst du $FORMATTED_NAME-Belohnungen ein  
          1. Klicke auf einen beliebigen Link oben  
          2. Warte, bis das Spiel startet  
          3. Deine Belohnungen werden automatisch eingelöst  

          **Tipps:**  
          - Links verfallen nach 48 Stunden  
          - Aktualisiere die Seite für neue Updates  
          - Kontaktiere den Support bei fehlgeschlagenen Ansprüchen" > "_includes/${GAME_NAME}_footer.html"

      - name: Deploy Changes
        env: 
          DEPLOY_KEY: ${{ secrets.ACTIONS_DEPLOY_KEY }}
        run: |
          git config user.email "prolladmail@gmail.com"
          git config user.name "Auto-Updater"
          
          # Ensure no unstaged changes before pulling
          git add -A
          git commit -m "Auto-commit before pulling changes" || echo "No changes to commit"
          
          # Fetch latest changes
          git fetch origin main
          
          # Ensure local branch is up-to-date with the remote
          git pull --rebase origin main || { echo 'Rebase failed, attempting merge instead...'; git merge origin/main; }
          
          # Stage all changes
          git add -A
          git commit -m "Update ${{ matrix.game }} content" || echo "No changes to commit"
          
          # Push changes safely with lease (prevents overwriting remote changes)
          git push --force-with-lease https://x-access-token:$DEPLOY_KEY@github.com/Prollad99/bs-de.git HEAD:main
