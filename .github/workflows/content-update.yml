name: Update Links and Deployment

on:
  schedule:
    - cron: '*/30 * * * *'
  push:
    branches:
      - main

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.npm
            ~/.cache/playwright
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

      - name: Install dependencies
        run: |
          npm ci
          sudo apt-get update
          sudo apt-get install -y libgbm-dev
          npx playwright install --with-deps

      - name: Process game links
        shell: bash
        env:
          GAMES: "coin-master monopoly-go bingo-blitz dice-dreams match-masters solitaire-grand-harvest slotpark house-of-fun slotomania bingo-bash huuuge-casino wsop crazy-coin gametwist"
        run: |
          git config --global user.email "prolladmail@gmail.com"
          git config --global user.name "Prollad99"
          git config --global pull.rebase true

          for GAME in $GAMES; do
            echo "üîÑ Processing $GAME..."
            
            # Run game script
            if ! node "index-js/$GAME.js"; then
              echo "‚ùå Error processing $GAME script"
              exit 1
            fi

            # Game type mapping
            declare -A GAME_TYPES=(
              ["bingo-bash"]="Gratis Chips"
              ["bingo-blitz"]="Gratis Credits"
              ["coin-master"]="Gratis Spins"
              ["crazy-coin"]="Gratis Spins"
              ["dice-dreams"]="Gratis W√ºrfe"
              ["gametwist"]="Gratis M√ºnzen"
              ["house-of-fun"]="Gratis M√ºnzen"
              ["huuuge-casino"]="Gratis Chips"
              ["match-masters"]="Gratis Geschenke"
              ["monopoly-go"]="W√ºrfel"
              ["slotomania"]="Gratis M√ºnzen"
              ["slotpark"]="Bonuscode"
              ["solitaire-grand-harvest"]="Gratis M√ºnzen"
              ["wsop"]="Gratis Chips"
            )

            # Format names
            GAME_NAME=$(echo "$GAME" | sed 's/-/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)}1')
            GAME_TYPE=${GAME_TYPES[$GAME]}

            # Generate SEO-optimized post content
            POST_CONTENT=$(cat <<HTML
<div class="container mt-4">
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white">
      <h2 class="h4 mb-0">${GAME_NAME} ${GAME_TYPE} ‚Äì T√§gliche Gratis Links</h2>
    </div>
    <div class="card-body">
      <div class="alert alert-info d-flex align-items-center">
        <i class="bi bi-arrow-clockwise me-2"></i>
        Letzte Aktualisierung: $(date +"%d.%m.%Y %H:%M Uhr")
      </div>

      <div class="row g-4">
        <div class="col-lg-6">
          <div class="card h-100">
            <div class="card-body">
              <h3 class="h5 card-title mb-3"><i class="bi bi-gift me-2"></i>So erhalten Sie ${GAME_TYPE}:</h3>
              <ol class="list-group list-group-numbered">
                <li class="list-group-item d-flex align-items-start">
                  <span class="me-auto">Kostenlosen Link ausw√§hlen</span>
                </li>
                <li class="list-group-item d-flex align-items-start">
                  <span class="me-auto">In ${GAME_NAME} einl√∂sen</span>
                </li>
                <li class="list-group-item d-flex align-items-start">
                  <span class="me-auto">${GAME_TYPE} sofort erhalten</span>
                </li>
              </ol>
            </div>
          </div>
        </div>

        <div class="col-lg-6">
          <div class="card h-100">
            <div class="card-body">
              <h3 class="h5 card-title mb-3"><i class="bi bi-star me-2"></i>Vorteile:</h3>
              <div class="list-group">
                <div class="list-group-item">
                  <i class="bi bi-check2-circle text-success me-2"></i>
                  T√§glich neue Links
                </div>
                <div class="list-group-item">
                  <i class="bi bi-shield-check text-success me-2"></i>
                  100% sichere Quellen
                </div>
                <div class="list-group-item">
                  <i class="bi bi-phone text-success me-2"></i>
                  Mobile & Desktop optimiert
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-4">
        <h3 class="h5 mb-3"><i class="bi bi-link-45deg me-2"></i>Aktuelle ${GAME_TYPE} Links:</h3>
        <!-- Links will be inserted here -->
      </div>
    </div>
  </div>
</div>
HTML
            )

            # Generate SEO footer
            FOOTER_CONTENT=$(cat <<HTML
<div class="container mt-4">
  <div class="row g-4">
    <div class="col-md-6">
      <div class="card border-0">
        <div class="card-body">
          <h3 class="h5"><i class="bi bi-lightbulb me-2"></i>${GAME_NAME} Tipps</h3>
          <ul class="list-unstyled">
            <li class="mb-2"><i class="bi bi-chevron-right me-2"></i>${GAME_TYPE} f√ºr Events sparen</li>
            <li class="mb-2"><i class="bi bi-chevron-right me-2"></i>T√§gliche Login-Belohnungen</li>
            <li><i class="bi bi-chevron-right me-2"></i>Strategische Spieloptimierung</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card border-0">
        <div class="card-body">
          <h3 class="h5"><i class="bi bi-question-circle me-2"></i>H√§ufige Fragen</h3>
          <div class="accordion" id="faqAccordion">
            <div class="accordion-item">
              <h4 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne">
                  Link funktioniert nicht?
                </button>
              </h4>
              <div id="collapseOne" class="accordion-collapse collapse">
                <div class="accordion-body">
                  Neue Links werden t√§glich um 08:00 MEZ aktualisiert
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="mt-4 text-center text-muted small">
    <p class="mb-1">Unabh√§ngiges Fan-Portal - Nicht verbunden mit ${GAME_NAME}</p>
    <p class="mb-0">¬© $(date +"%Y") ${GAME_NAME} ${GAME_TYPE} | Alle Rechte vorbehalten</p>
  </div>
</div>
HTML
            )

            # Save HTML files
            echo "$POST_CONTENT" > "_includes/${GAME}_post.html"
            echo "$FOOTER_CONTENT" > "_includes/${GAME}_footer.html"

            git add "_includes/${GAME}_post.html" "_includes/${GAME}_footer.html"
          done

          # Commit and push changes
          git commit -m "üöÄ SEO Boost: Updated game content - $(date +'%d.%m.%Y %H:%M')" || echo "‚è© No changes to commit"
          
          # Push with retry logic
          for i in {1..5}; do
            git pull --rebase
            if git push "https://x-access-token:${{ secrets.ACTIONS_DEPLOY_KEY }}@github.com/Prollad99/bs-de.git" HEAD:main; then
              echo "‚úÖ Successfully pushed changes"
              break
            else
              echo "üîÑ Retry push attempt $i/5..."
              sleep 5
            fi
          done

          if [ $? -ne 0 ]; then
            echo "‚ùå All push attempts failed"
            exit 1
          fi