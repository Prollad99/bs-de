name: Update Links and Deployment

on:
  schedule:
    - cron: "*/30 * * * *"  # Runs every 30 minutes
  push:
    branches:
      - main

jobs:
  update-links:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        game:
          - coin-master
          - monopoly-go
          - bingo-blitz
          - dice-dreams
          - match-masters
          - solitaire-grand-harvest
          - slotpark
          - house-of-fun
          - slotomania
          - bingo-bash
          - huuuge-casino
          - wsop
          - crazy-coin
          - gametwist

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Cache Node Modules
        uses: actions/cache@v2
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install Dependencies
        run: npm install

      - name: Install Playwright Browsers
        run: npx playwright install

      - name: Fetch and Update Links
        run: |
          node index-js/${{ matrix.game }}.js
          echo "Content of links-json/${{ matrix.game }}.json:"
          cat links-json/${{ matrix.game }}.json
          echo "Content of _includes/${{ matrix.game }}.html:"
          cat _includes/${{ matrix.game }}.html

      - name: Generate Dynamic Post Content
        run: |
          GAME_NAME=${{ matrix.game }}
          GAME_NAME_CAPITALIZED=$(echo "$GAME_NAME" | sed 's/-/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)}1')

          POST_FILE="_includes/${GAME_NAME}_post.html"
          POST_CONTENT="Entdecke tägliche ${GAME_NAME_CAPITALIZED} Belohnungen!\n\n
          Bist du ein Fan von ${GAME_NAME_CAPITALIZED}, der sein Spielerlebnis verbessern möchte? Du bist hier genau richtig! Diese Seite ist allen ${GAME_NAME_CAPITALIZED}-Fans gewidmet, die kostenlose tägliche Belohnungen sammeln möchten.\n\n
          Hinweis: ${GAME_NAME_CAPITALIZED} ist eine kostenlose App, die zu Unterhaltungszwecken entwickelt wurde. Bonuscollector.de ist eine unabhängige Plattform und steht nicht in Verbindung mit den Entwicklern oder Eigentümern des Spiels.\n\n
          Komm täglich vorbei, damit du keine Belohnungen verpasst!"
          echo -e "$POST_CONTENT" > "$POST_FILE"

      - name: Generate Dynamic Footer Content
        run: |
          GAME_NAME=${{ matrix.game }}
          GAME_NAME_CAPITALIZED=$(echo "$GAME_NAME" | sed 's/-/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)}1')

          FOOTER_FILE="_includes/${GAME_NAME}_footer.html"
          FOOTER_CONTENT="### So beanspruchst du deine ${GAME_NAME_CAPITALIZED} Belohnungen\n\n
          1. Durchsuche die obigen Belohnungslinks und wähle die aus, die du beanspruchen möchtest.\n
          2. Klicke auf einen Link, um zur ${GAME_NAME_CAPITALIZED}-App oder -Website weitergeleitet zu werden.\n
          3. Melde dich an deinem Konto an, falls du dazu aufgefordert wirst.\n
          4. Deine Belohnung (kostenlose Spins, Münzen, Chips oder Boni) wird deinem Konto hinzugefügt.\n\n
          **Tipps zum Beanspruchen von Belohnungen:**\n
          - Stelle sicher, dass du in deinem ${GAME_NAME_CAPITALIZED}-Konto angemeldet bist, bevor du auf die Links klickst.\n
          - Die meisten Links können nur einmal beansprucht werden. Schaue also täglich für neue vorbei.\n
          - Wenn ein Link nicht funktioniert, ist er möglicherweise abgelaufen. Beanspruche deine Belohnungen so schnell wie möglich.\n\n
          Viel Spaß beim Sammeln deiner Belohnungen und beim Spielen von ${GAME_NAME_CAPITALIZED}!"
          echo -e "$FOOTER_CONTENT" > "$FOOTER_FILE"

      - name: Update Last Modified Timestamp
        run: |
          export TZ=UTC
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S")
          INCLUDE_FILES_YML="_data/include_files.yml"

          if git diff --quiet _includes/${{ matrix.game }}.html; then
            echo "_includes/${{ matrix.game }}.html has not changed. Skipping timestamp update."
          else
            if grep -q "${{ matrix.game }}.html:" "$INCLUDE_FILES_YML"; then
              sed -i "/${{ matrix.game }}.html:/,/last_modified:/s|last_modified: .*|last_modified: $TIMESTAMP|" "$INCLUDE_FILES_YML"
            else
              echo -e "\n${{ matrix.game }}.html:\n  last_modified: $TIMESTAMP" >> "$INCLUDE_FILES_YML"
            fi
          fi

      - name: Configure Git
        run: |
          git config --global user.email "prolladmail@gmail.com"
          git config --global user.name "Prollad99"

      - name: Commit and Push Changes
        env:
          ACTIONS_DEPLOY_KEY: ${{ secrets.ACTIONS_DEPLOY_KEY }}
        run: |
          git add _includes/${{ matrix.game }}.html _includes/${{ matrix.game }}_post.html _includes/${{ matrix.game }}_footer.html links-json/${{ matrix.game }}.json _data/include_files.yml
          git add package.json package-lock.json || true
          git commit -m "Update ${{ matrix.game }} reward links, content, and modification timestamp" || true
          git stash
          git pull --rebase || true
          git stash pop || true
          for i in {1..5}; do
            git push https://x-access-token:${{ secrets.ACTIONS_DEPLOY_KEY }}@github.com/Prollad99/bs-de.git && break
            echo "Attempt $i: Push failed, retrying in 5 seconds..."
            sleep 5
            git pull --rebase || true
          done