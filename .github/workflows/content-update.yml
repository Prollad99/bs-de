name: Aktualisiere Links und Bereitstellung

on:
  schedule:
    - cron: '*/30 * * * *' # L√§uft alle 30 Minuten
  push:
    branches:
      - main

jobs:
  links-aktualisieren:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        game:
          - coin-master
          - monopoly-go
          - bingo-blitz
          - dice-dreams
          - match-masters
          - solitaire-grand-harvest
          - slotpark
          - house-of-fun
          - slotomania
          - bingo-bash
          - huuuge-casino
          - wsop
          - crazy-coin
          - gametwist

    steps:
      - name: Repository auschecken
        uses: actions/checkout@v2

      - name: Node-Module zwischenspeichern
        uses: actions/cache@v2
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Abh√§ngigkeiten installieren
        run: npm install

      - name: Installiere Playwright-Browser
        run: npx playwright install

      - name: Links abrufen und aktualisieren
        run: |
          node index-js/${{ matrix.game }}.js
          echo "Inhalt von links-json/${{ matrix.game }}.json:"
          cat links-json/${{ matrix.game }}.json

      - name: Dynamische Beitragsinhalte generieren
        run: |
          SPIEL_NAME=${{ matrix.game }}
          SPIEL_NAME_KAPITALISIERT=$(echo "$SPIEL_NAME" | sed 's/-/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)}1')

          ABSATZ_DATEI="_includes/${SPIEL_NAME}_post.html"

          ABSATZ="## T√§gliche ${SPIEL_NAME_KAPITALISIERT}-Belohnungen & Strategien

          **Willkommen, ${SPIEL_NAME_KAPITALISIERT}-Fans!**  
          Suchst du nach den neuesten Gratis-Belohnungen f√ºr ${SPIEL_NAME_KAPITALISIERT}? Dann bist du hier genau richtig! Wir aktualisieren t√§glich die besten Links f√ºr Freispiele, M√ºnzen und andere Boni, damit du dein Spielerlebnis optimal genie√üen kannst.  

          ### Was ist ${SPIEL_NAME_KAPITALISIERT} und warum sind Belohnungen wichtig?  
          ${SPIEL_NAME_KAPITALISIERT} ist ein beliebtes Spiel, das von Millionen gespielt wird. Mit t√§glichen Belohnungen kannst du l√§nger spielen, schneller leveln und das Beste aus deinem Spielerlebnis herausholen.  

          ### üöÄ T√§gliche Belohnungslinks f√ºr ${SPIEL_NAME_KAPITALISIERT}  
          ‚úÖ [Hier die neuesten Links einf√ºgen]  
          *(Diese Liste wird t√§glich aktualisiert ‚Äì speichere die Seite und schaue regelm√§√üig vorbei!)*  

          ### üèÜ Profi-Tipps f√ºr ${SPIEL_NAME_KAPITALISIERT} Spieler  
          - **Nutze Belohnungen strategisch**: Warte auf knifflige Spielmomente, um Boni einzul√∂sen.  
          - **Verbinde dich mit Freunden**: Viele Spiele bieten Extra-Belohnungen f√ºr das Einladen von Freunden.  
          - **Bleibe auf dem Laufenden**: Folge offiziellen ${SPIEL_NAME_KAPITALISIERT}-Social-Media-Seiten f√ºr weitere Geheimtipps.  

          ### ‚ùì H√§ufig gestellte Fragen (FAQ)  
          **Wie oft kann ich die Belohnungslinks nutzen?**  
          üëâ Jeder Link ist normalerweise nur einmal g√ºltig. T√§glich neue Links nutzen!  

          **Warum funktioniert ein Link nicht?**  
          üëâ Einige Links haben eine begrenzte Laufzeit. Falls ein Link abgelaufen ist, probiere die neuesten aus.  

          ### üìå Fazit  
          Vergiss nicht, t√§glich zur√ºckzukommen, um neue Belohnungen zu erhalten! Speichere diese Seite oder teile sie mit deinen Freunden. Viel Spa√ü beim Spielen von ${SPIEL_NAME_KAPITALISIERT}!"  

          echo -e "$ABSATZ" > "$ABSATZ_DATEI"

      - name: Letztes √Ñnderungsdatum der Include-Datei aktualisieren
        run: |
          export TZ=UTC
          ZEITSTEMPEL=$(date -u +"%Y-%m-%d %H:%M:%S")
          INCLUDE_FILES_YML="_data/include_files.yml"

          if git diff --quiet _includes/${{ matrix.game }}_post.html; then
            echo "_includes/${{ matrix.game }}_post.html wurde nicht ge√§ndert. Aktualisierung des letzten √Ñnderungsdatums √ºbersprungen."
          else
            if grep -q "${{ matrix.game }}_post.html:" "$INCLUDE_FILES_YML"; then
              sed -i "/${{ matrix.game }}_post.html:/,/last_modified:/s|last_modified: .*|last_modified: $ZEITSTEMPEL|" "$INCLUDE_FILES_YML"
            else
              echo -e "\n${{ matrix.game }}_post.html:\n  last_modified: $ZEITSTEMPEL" >> "$INCLUDE_FILES_YML"
            fi
          fi

      - name: Git konfigurieren
        run: |
          git config --global user.email "prolladmail@gmail.com"
          git config --global user.name "Prollad99"

      - name: √Ñnderungen committen und pushen
        env:
          ACTIONS_DEPLOY_KEY: ${{ secrets.ACTIONS_DEPLOY_KEY }}
        run: |
          git add _includes/${{ matrix.game }}_post.html links-json/${{ matrix.game }}.json _data/include_files.yml
          git add package.json package-lock.json || true
          git commit -m "Aktualisiere ${SPIEL_NAME}-Belohnungslinks, Inhalte und √Ñnderungsdatum" || true
          git stash
          git pull --rebase || true
          git stash pop || true
          for i in {1..5}; do
            git push https://x-access-token:${{ secrets.ACTIONS_DEPLOY_KEY }}@github.com/Prollad99/bs-de.git && break
            echo "Versuch $i: Push fehlgeschlagen, erneuter Versuch in 5 Sekunden..."
            sleep 5
            git pull --rebase || true
          done