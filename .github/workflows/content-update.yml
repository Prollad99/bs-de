Name: Update Links and Deployment

on:
  schedule:
    - cron: '*/30 * * * *'  # Runs every 30 minutes
  push:
    branches:
      - main

jobs:
  update-links:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        game:
          - coin-master
          - monopoly-go
          - bingo-blitz
          - dice-dreams
          - match-masters
          - solitaire-grand-harvest
          - slotpark
          - house-of-fun
          - slotomania
          - bingo-bash
          - huuuge-casino
          - wsop
          - crazy-coin
          - gametwist

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Cache Node Modules
        uses: actions/cache@v2
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install Dependencies
        run: npm install

      - name: Install Playwright Browsers
        run: npx playwright install

      - name: Fetch and Update Links
        run: |
          node index-js/${{ matrix.game }}.js
          echo "Content of links-json/${{ matrix.game }}.json:"
          cat links-json/${{ matrix.game }}.json
          echo "Content of _includes/${{ matrix.game }}.html:"
          cat _includes/${{ matrix.game }}.html

      - name: Generate Dynamic Post Content
        run: |
          GAME_NAME=${{ matrix.game }}
          GAME_NAME_CAPITALIZED=$(echo "$GAME_NAME" | sed 's/-/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)}1')

          POST_FILE="_includes/${GAME_NAME}_post.html"
          POST_CONTENT="Willkommen auf der täglichen ${GAME_NAME_CAPITALIZED}-Belohnungsseite!\n\n
          Wenn Sie ein engagierter Fan von ${GAME_NAME_CAPITALIZED} sind, haben wir etwas Besonderes für Sie! Hier finden Sie aktualisierte Links zu kostenlosen Drehungen, Münzen, Chips und anderen Boni, die Ihr Spielerlebnis verbessern.\n\n
          **Was macht ${GAME_NAME_CAPITALIZED} so besonders?**\n
          ${GAME_NAME_CAPITALIZED} hat die Herzen von Millionen Spielern auf der ganzen Welt erobert. Mit seinem fesselnden Gameplay, herausfordernden Wettbewerben und spannenden Events ist es ein Muss für alle, die Spaß, Strategie und Belohnungen lieben.\n\n
          **Tägliche Belohnungen:**\n
          - Frische Belohnungslinks, die regelmäßig aktualisiert werden.\n
          - Verpassen Sie keinen Bonus – setzen Sie ein Lesezeichen für diese Seite und schauen Sie täglich vorbei.\n
          - Sichern Sie sich Drehungen, Münzen und exklusive Boni, bevor sie ablaufen!\n\n
          **Warum unsere Plattform nutzen?**\n
          - Einfaches, benutzerfreundliches Erlebnis.\n
          - Überprüfte und aktive Belohnungslinks.\n
          - Schneller Zugriff ohne komplizierte Schritte.\n\n
          *Hinweis: ${GAME_NAME_CAPITALIZED} ist eine kostenlose App, die zu Unterhaltungszwecken entwickelt wurde. Wir stehen in keiner Verbindung zu den Entwicklern oder Eigentümern des Spiels.*"
          echo -e "$POST_CONTENT" > "$POST_FILE"

      - name: Generate Dynamic Footer Content
        run: |
          GAME_NAME=${{ matrix.game }}
          GAME_NAME_CAPITALIZED=$(echo "$GAME_NAME" | sed 's/-/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)}1')

          FOOTER_FILE="_includes/${GAME_NAME}_footer.html"
          FOOTER_CONTENT="### So maximieren Sie Ihre ${GAME_NAME_CAPITALIZED}-Belohnungen\n\n
          Folgen Sie diesen einfachen Schritten, um Ihre täglichen Boni zu beanspruchen:\n
          1. Durchsuchen Sie die oben aufgeführten verifizierten Belohnungslinks.\n
          2. Klicken Sie auf einen Link, um zum Spiel oder zur offiziellen Seite weitergeleitet zu werden.\n
          3. Stellen Sie sicher, dass Sie in Ihr ${GAME_NAME_CAPITALIZED}-Konto eingeloggt sind.\n
          4. Genießen Sie Ihre Belohnungen sofort nach dem Einlösen.\n\n
          **Fehlerbehebung:**\n
          - Wenn ein Belohnungslink nicht funktioniert, ist er möglicherweise bereits abgelaufen.\n
          - Stellen Sie sicher, dass Ihr Spiel auf die neueste Version aktualisiert ist.\n
          - Löschen Sie Ihren Cache und versuchen Sie es erneut, falls Probleme auftreten.\n\n
          **Sicherheitstipps:**\n
          - Teilen Sie Ihre Spielanmeldedaten niemals mit anderen.\n
          - Klicken Sie nur auf vertrauenswürdige Links aus überprüften Quellen.\n\n
          *Hinweis: Die Belohnungslinks können schnell ablaufen, besuchen Sie daher täglich die Seite für die neuesten Updates.*\n
          Viel Spaß beim Spielen!"
          echo -e "$FOOTER_CONTENT" > "$FOOTER_FILE"

      - name: Update Last Modified Timestamp
        run: |
          export TZ=UTC
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S")
          INCLUDE_FILES_YML="_data/include_files.yml"

          if git diff --quiet _includes/${{ matrix.game }}.html; then
            echo "_includes/${{ matrix.game }}.html has not changed. Skipping timestamp update."
          else
            if grep -q "${{ matrix.game }}.html:" "$INCLUDE_FILES_YML"; then
              sed -i "/${{ matrix.game }}.html:/,/last_modified:/s|last_modified: .*|last_modified: $TIMESTAMP|" "$INCLUDE_FILES_YML"
            else
              echo -e "\n${{ matrix.game }}.html:\n  last_modified: $TIMESTAMP" >> "$INCLUDE_FILES_YML"
            fi
          fi

      - name: Configure Git
        run: |
          git config --global user.email "prolladmail@gmail.com"
          git config --global user.name "Prollad99"

      - name: Commit and Push Changes
        env:
          ACTIONS_DEPLOY_KEY: ${{ secrets.ACTIONS_DEPLOY_KEY }}
        run: |
          git add _includes/${{ matrix.game }}.html _includes/${{ matrix.game }}_post.html _includes/${{ matrix.game }}_footer.html links-json/${{ matrix.game }}.json _data/include_files.yml
          git add package.json package-lock.json || true
          git commit -m "Update ${{ matrix.game }} reward links, content, and modification timestamp" || true
          git stash
          git pull --rebase || true
          git stash pop || true
          for i in {1..5}; do
            git push https://x-access-token:${{ secrets.ACTIONS_DEPLOY_KEY }}@github.com/Prollad99/bs-de.git && break
            echo "Attempt $i: Push failed, retrying in 5 seconds..."
            sleep 5
            git pull --rebase || true
          done