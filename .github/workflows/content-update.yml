name: Update Links and Deployment

on:
  schedule:
    - cron: '*/30 * * * *' # Runs every 30 minutes
  push:
    branches:
      - main

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.npm
            ~/.cache/playwright
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

      - name: Install dependencies
        run: |
          npm ci
          sudo apt-get update
          sudo apt-get install -y libgbm-dev
          npx playwright install --with-deps

      - name: Process game links
        shell: bash
        env:
          GAMES: "coin-master monopoly-go bingo-blitz dice-dreams match-masters solitaire-grand-harvest slotpark house-of-fun slotomania bingo-bash huuuge-casino wsop crazy-coin gametwist"
        run: |
          # Initialize git configuration
          git config --global user.email "prolladmail@gmail.com"
          git config --global user.name "Prollad99"
          git config --global pull.rebase true

          # Process each game sequentially
          for GAME in $GAMES; do
            echo "‚ÑπÔ∏è Processing $GAME..."
            
            # Run game-specific script
            if ! node "index-js/$GAME.js"; then
              echo "‚ùå Error processing $GAME script"
              exit 1
            fi

            # Generate content files
            declare -A GAME_TYPES=(
              ["bingo-bash"]="Gratis Chips"
              ["bingo-blitz"]="Gratis Credits"
              ["coin-master"]="Gratis Spins"
              ["crazy-coin"]="Gratis Spins"
              ["dice-dreams"]="Gratis W√ºrfe"
              ["gametwist"]="Gratis M√ºnzen"
              ["house-of-fun"]="Gratis M√ºnzen"
              ["huuuge-casino"]="Gratis Chips"
              ["match-masters"]="Gratis Geschenke"
              ["monopoly-go"]="W√ºrfel"
              ["slotomania"]="Gratis M√ºnzen"
              ["slotpark"]="Bonuscode"
              ["solitaire-grand-harvest"]="Gratis M√ºnzen"
              ["wsop"]="Gratis Chips"
            )

            # Format game name
            GAME_NAME_CAPITALIZED=$(echo "$GAME" | sed 's/-/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)}1')
            GAME_TYPE=${GAME_TYPES[$GAME]}

            # Generate post content
            POST_CONTENT="Bist du ein leidenschaftlicher **${GAME_NAME_CAPITALIZED}**-Spieler? M√∂chtest du **${GAME_TYPE}** sammeln, ohne echtes Geld auszugeben? Dann bist du hier genau richtig!  

            Wir aktualisieren diese Seite **t√§glich** mit neuen **${GAME_TYPE}**-Links, damit du dein Gameplay verbessern, schneller aufsteigen und spannende Belohnungen freischalten kannst ‚Äì v√∂llig kostenlos.  

            ---  

            ## **Was sind ${GAME_TYPE}-Links?**  

            **${GAME_TYPE}**-Links sind offizielle Belohnungen der **${GAME_NAME_CAPITALIZED}**-Entwickler. Sie bieten kostenlose **${GAME_TYPE}** und weitere In-Game-Boni wie Spins, W√ºrfe, Credits und spezielle Geschenke.  

            Statt selbst danach zu suchen, √ºbernehmen wir die Arbeit f√ºr dich! Wir sammeln und aktualisieren t√§glich die neuesten funktionierenden Links, damit du deine Gratis-Belohnungen m√ºhelos einl√∂sen kannst.  

            ---  

            ## **So l√∂st du deine kostenlosen ${GAME_TYPE} ein**  

            Deine **${GAME_TYPE}** zu erhalten ist schnell und einfach:  

            1. **W√§hle einen Link aus der Liste unten.**  
            2. **Klicke auf den Link und melde dich in deinem ${GAME_NAME_CAPITALIZED}-Konto an.**  
            3. **Genie√üe deine kostenlosen ${GAME_TYPE} ‚Äì sofort in deinem Spiel verf√ºgbar!**  

            > üîî **Tipp:** Diese Links laufen schnell ab ‚Äì schau t√§glich vorbei, um dir deine Belohnungen zu sichern!  

            ---  

            ## **Heutige Gratis-${GAME_TYPE} f√ºr ${GAME_NAME_CAPITALIZED}**"

            # Generate footer content
            FOOTER_CONTENT="---  

            ## **Warum solltest du diese Seite speichern?**  

            Wir machen es dir leicht, in **${GAME_NAME_CAPITALIZED}** vorne mit dabei zu sein ‚Äì mit t√§glichen Updates und gepr√ºften Links. Hier sind die Gr√ºnde, warum du uns t√§glich besuchen solltest:  

            ‚úÖ **T√§gliche Updates:** Wir posten jeden Tag die neuesten kostenlosen **${GAME_TYPE}**-Links.  
            ‚úÖ **100 % sicher & gepr√ºft:** Alle Links stammen aus offiziellen **${GAME_NAME_CAPITALIZED}**-Quellen.  
            ‚úÖ **Komplett kostenlos:** Keine Anmeldung, keine versteckten Geb√ºhren ‚Äì nur kostenlose In-Game-Belohnungen!  

            ---  

            ## **Maximiere deine Gratis-${GAME_TYPE} mit diesen Profi-Tipps**  

            M√∂chtest du das Beste aus deinen kostenlosen Belohnungen herausholen? Befolge diese Expertenstrategien:  

            - **Spins & W√ºrfe clever einsetzen:** Spare sie f√ºr Events mit hohen Belohnungen auf.  
            - **M√ºnzen & Credits geschickt verwalten:** Investiere sie strategisch, um schneller voranzukommen.  
            - **T√§glich einloggen:** Viele Links sind nur kurz g√ºltig ‚Äì sichere sie dir so schnell wie m√∂glich!  

            ---  

            ## **H√§ufig gestellte Fragen (FAQs)**  

            ### **1. Sind diese ${GAME_TYPE}-Links sicher?**  
            Ja! Wir teilen ausschlie√ülich Links, die direkt aus offiziellen **${GAME_NAME_CAPITALIZED}**-Aktionen stammen ‚Äì sie sind v√∂llig sicher und legitim.  

            ### **2. Wie oft werden die Links aktualisiert?**  
            Wir aktualisieren diese Seite **t√§glich** mit neuen funktionierenden Links ‚Äì schau also jeden Tag vorbei!  

            ### **3. Was, wenn ein Link nicht funktioniert?**  
            Einige Links haben eine begrenzte Anzahl an Einl√∂sungen oder laufen schnell ab. Falls einer nicht funktioniert, keine Sorge ‚Äì neue werden bald verf√ºgbar sein!  

            ---  

            ## **Haftungsausschluss**  

            Wir sind **nicht mit** **${GAME_NAME_CAPITALIZED}** oder seinen Entwicklern **verbunden**. Diese Seite dient ausschlie√ülich zu Informationszwecken, um Spielern zu helfen, kostenlose **${GAME_TYPE}** zu erhalten und das Spiel in vollen Z√ºgen zu genie√üen."

            # Write content to files
            echo "$POST_CONTENT" > "_includes/${GAME}_post.html"
            echo "$FOOTER_CONTENT" > "_includes/${GAME}_footer.html"

            # Add changed files to git
            git add "index-js/$GAME.js" \
                   "_includes/$GAME.html" \
                   "_includes/${GAME}_post.html" \
                   "_includes/${GAME}_footer.html" \
                   "links-json/$GAME.json"
          done

          # Commit changes
          git commit -m "ü§ñ Auto-update: $(date +'%Y-%m-%d %H:%M')" || echo "‚è© No changes to commit"

          # Push changes with retry logic
          MAX_RETRIES=5
          for ((i=1; i<=$MAX_RETRIES; i++)); do
            git pull --rebase
            if git push "https://x-access-token:${{ secrets.ACTIONS_DEPLOY_KEY }}@github.com/Prollad99/bs-de.git" HEAD:main; then
              echo "‚úÖ Push successful"
              break
            else
              echo "üîÑ Attempt $i/$MAX_RETRIES failed, retrying in 5 seconds..."
              sleep 5
            fi
          done

          if [ $i -gt $MAX_RETRIES ]; then
            echo "‚ùå All push attempts failed"
            exit 1
          fi